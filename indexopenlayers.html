<!doctype html>
<meta charset="utf-8"/>
<html lang="en">

<head>
  <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" type="text/css" href="styles.css">
  <style>
  .map {
    height: 790px;
    width: 100%;
  }
  </style>
  <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
  <script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCmeDbv8eGM8sPlpIGBiT6fxJJD-wujSBM",
    authDomain: "gppthermometer.firebaseapp.com",
    databaseURL: "https://gppthermometer.firebaseio.com",
    projectId: "gppthermometer",
    storageBucket: "",
    messagingSenderId: "639524050247"
  };
  firebase.initializeApp(config);
  </script>
  <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link href="ol-geocoder.min.css" rel="stylesheet">
  <script src="ol-geocoder-debug.js"></script>
  <title>OpenLayers example</title>
  <script>
  function logOut(){
    firebase.auth().signOut().then(function() {
      window.location = "login.html";
      // Sign-out successful.
    }).catch(function(error) {
      // An error happened.
    });
  }

  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      document.getElementById("displayName").innerHTML = user.displayName;
    } else {
      window.location = "login.html";
    }
  });
</script>
</head>

<body>
  <div class="w3-bar w3-light-blue w3-border">
    <a href="#" class="w3-bar-item w3-button material-icons w3-hover-text-white w3-hover-none" onclick="window.location = 'indexopenlayers.html';">home</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-text-white w3-hover-none" onclick="logOut()">Logout</a>
    <a>Welkom <span id = "displayName"></span></a>
    <a href="#" class="w3-bar-item w3-button w3-right material-icons w3-hover-text-white w3-hover-none">shopping_cart</a>
  </div>

  <div class="w3-row-padding" style="padding-top:10px;">
    <div class="w3-col s8 m8 l8 ">
      <div id="map" class="map"></div>
      <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
      </div>
    </div>

    <div class="w3-col s4 m4 l4" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)">
      <div class="w3-bar w3-black">
        <button class="w3-bar-item w3-button" onclick="openTab('Locatie')">Locatie</button>
        <button class="w3-bar-item w3-button" onclick="openTab('Wetgeving')">Wetgeving</button>
        <button class="w3-bar-item w3-button" onclick="openTab('Geluid')">Geluid</button>
      </div>
      <div id="Locatie" class="tabs">
        <p>ID: <span id = "id"></span></p>
        <p>X-coördinaat (RD): <span id = "Xcoordinaat"></span></p>
        <p>Y-coördinaat (RD): <span id = "Ycoordinaat"></span></p>
        <p>Hoogte referentiepunt t.o.v. maaiveld: <span id = "Zcoordinaat"></span></p>
      </div>
      <div id="Wetgeving" class="tabs" style="display:none">
        <p>Artikel: <span id = "artikel"></span></p>
        <p>Plafondcorrectiewaarde: </p>
        <p>Besluit: </p>
        <p>Ingangsdatum: </p>
      </div>
      <div id="Geluid" class="tabs" style="display:none">
        <p>Geluidproductieplafond: <span id = "gpp"></span></p>
        <p>Geluidproductie Realtime: </p>
        <p>Geluidruimte Realtime: </p>
        <p>Voorspelde totale geluidproductie: </p>
        <p>Buiten bedrijf: </p>
        <p>Laatste meting: </p>
        <div id="linechart_material" style="width: 100%; height: 100%"></div>
      </div>
    </div>
  </div>
  <script type="text/javascript">

  var container = document.getElementById('popup');
  var content = document.getElementById('popup-content');
  var closer = document.getElementById('popup-closer');

  var overlay = new ol.Overlay({
    element: container,
    autoPan: true,
    autoPanAnimation: {
      duration: 1
    }
  });
  closer.onclick = function() {
    overlay.setPosition(undefined);
    closer.blur();
    return false;
  };

  var geocoder = new Geocoder('nominatim', {
    provider: 'osm',
    lang: 'nl-NL',
    autoComplete: true,
    autoCompleteMinLength: 3,
    placeholder: 'Vul hier uw postcode of adres in',
    targetType: 'text-input',
    limit: 7,
    countrycodes: 'nl',
    keepOpen: false,
    preventDefault: false
  });

  var features = [];

  $.ajax({
    url: 'https://raw.githubusercontent.com/Meesgieling/performance/master/data.json?token=ALZ4izbaLrdZJDtFMD01Xde785bZna-Hks5a6BbRwA%3D%3D', //http://172.16.29.41:8080/geoserver/geluidregister/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geluidregister:c207_geluidproductieplafonds&maxFeatures=61000&outputFormat=application%2Fjson
    dataType: 'json',
    async: false,
    success: function(json1) {
      $.each(json1, function(key, data) {
        if (key == 'features') {
          $.each(data, function(k, v) {
            if (v.type == 'Feature') {
              if (v.geometry.coordinates.length > 1) {
                features[k] = new ol.Feature({
                  geometry: new ol.geom.Point(v.geometry.coordinates),
                  id: v.properties.id,
                  artikel: v.properties.artikel,
                  Xcoordinaat: v.properties.point_x,
                  Ycoordinaat: v.properties.point_y,
                  Zcoordinaat: v.properties.point_z,
                  gpp: v.properties.gpp
                });
              }
            }
          });
        }
      });
    }
  });

  /*
  var layers = [
  new ol.layer.Tile({
  source: new ol.source.OSM()
}),
new ol.layer.Image({
extent: [-13884991, 2870341, -7455066, 6338219],
source: new ol.source.ImageWMS({
url: 'http://172.16.29.41:8080/geoserver/geluidregister/wms?service=WMS&version=1.1.0&request=GetMap&layers=geluidregister:c207_geluidproductieplafonds&styles=&bbox=394143.1875,6578046.5,804491.3125,7063132.5&width=649&height=768&srs=EPSG:900913&format=application/openlayers',
params: {'LAYERS': 'geluidregister:c207_geluidproductieplafonds'},
ratio: 1,
serverType: 'geoserver'
})
})
];*/

var source = new ol.source.Vector({
  features: features
});

var clusterSource = new ol.source.Cluster({
  distance: 6,
  source: source
});

var raster = new ol.layer.Tile({
  source: new ol.source.OSM({
    preload: 8
  })
});

var styleCache = {};
var clusters = new ol.layer.Vector({
  source: clusterSource,
  style: function(feature) {
    var size = feature.get('features').length;
    var style = styleCache[size];
    if (!style) {
      style = new ol.style.Style({
        image: new ol.style.Circle({
          radius: 10,
          stroke: new ol.style.Stroke({
            color: '#fff'
          }),
          fill: new ol.style.Fill({
            color: '#3399CC'
          })
        }),
        text: new ol.style.Text({
          text: size.toString(),
          fill: new ol.style.Fill({
            color: '#fff'
          })
        })
      });
      styleCache[size] = style;
    }
    return style;
  }
});

var map = new ol.Map({
  target: 'map',
  layers: [raster, clusters],
  overlays: [overlay],
  view: new ol.View({
    center: [568744.996128, 6816229.956732],
    zoom: 8,
    minZoom: 8,
    maxZoom: 16,
  })
});

map.on('singleclick', function(evt) {
  map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
    var coordinate = evt.coordinate;
    var featurelist = feature.N.features;
    if (featurelist.length > 0) {
      for (var i = 0, ii = featurelist.length; i < ii; ++i) {
        id = featurelist[i].N.id;
        artikel = featurelist[i].N.artikel;
        Xcoordinaat = featurelist[i].N.Xcoordinaat;
        Ycoordinaat = featurelist[i].N.Ycoordinaat;
        Zcoordinaat = featurelist[i].N.Zcoordinaat;
        gpp = featurelist[i].N.gpp;
        if (featurelist.length < 2) {
          document.getElementById("id").innerHTML = id;
          document.getElementById("artikel").innerHTML = artikel;
          document.getElementById("Xcoordinaat").innerHTML = Xcoordinaat;
          document.getElementById("Ycoordinaat").innerHTML = Ycoordinaat;
          document.getElementById("Zcoordinaat").innerHTML = Zcoordinaat + "m";
          document.getElementById("gpp").innerHTML = gpp + " dB";

          //      content.innerHTML = '<p>Klik op de knop voor extra informatie</p>' + '<button onclick="w3_open()">Data</button>';
        } else {
          content.innerHTML = 'U heeft ' + featurelist.length + ' punten aangeklikt. Voor meer informatie zoom in en klik één punt aan.';
          overlay.setPosition(coordinate);
        }

      }
    }
  })
});

map.addControl(geocoder);

google.charts.load('current', {'packages':['line']});
google.charts.setOnLoadCallback(drawChart);

function drawChart() {

  var data = new google.visualization.DataTable();
  data.addColumn('date', 'Datum');
  data.addColumn('number', 'Realtime');
  data.addColumn('number', 'GPP');

  data.addRows([
    [new Date(2014, 0),  5,  100],
    [new Date(2014, 1),   14,  100],
    [new Date(2014, 2),   25,   100],
    [new Date(2014, 3),  29, 100],
    [new Date(2014, 4),  63, 100],
    [new Date(2014, 5),    90, 100],
    [new Date(2014, 6), 61, 100],
    [new Date(2014, 7), 51, 100],
    [new Date(2014, 8),  74, 100],
    [new Date(2014, 9),  44,  100],
    [new Date(2014, 10), 11,  100],
    [new Date(2014, 11), 23,  100]
  ]);

  var options = {
    title: 'GPP Realtime Percentage',
    series: {2:{lineDashStyle: [2, 2], color: '64B8F8'}},
    vAxis: {title: '%',  ticks: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100], viewWindow:{
      max:100,
      min:0}},
      hAxis: {format: 'MMM',
      gridlines: {count: 12}},
      legend: { position: 'bottom' },
      width: 500,
      height: 500,
      chartArea: {'width': '100%', 'height': '100%'}
    };

    var chart = new google.charts.Line(document.getElementById('linechart_material'));

    chart.draw(data, google.charts.Line.convertOptions(options));
  }

  function openTab(Tabname) {
    var i;
    var x = document.getElementsByClassName("tabs");
    for (i = 0; i < x.length; i++) {
      x[i].style.display = "none";
    }
    document.getElementById(Tabname).style.display = "block";
  }
  </script>
</body>
</html>
